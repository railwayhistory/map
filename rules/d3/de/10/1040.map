# DE 1040.  Neumünster (ausschl) - Flensburg (einschl)
#
let altkie = path("path.de.1220");
let flefri = path("path.de.1005");
let flwhag = path("path.de.1000");
let flwlin = path("path.de.1001");
let hasfle = path("path.de.1020");
let husflw = path("path.de.12035");
let neufle = path("path.de.1040");
let neufle.neu = path("path.de.1040.neu");
let slefri = path("path.de.9103");
let slesla = path("path.de.1010");

with detail = 3 {
    # Streckengleis Neumünster - Osterrönfeld
    track(:double :first :cat, neufle[:aa, :oro - 1ssw]);
    with layer = -1 track(:double :first :gone,
            altkie[:ahei, :ahei + 0.1dl] << 1dt
        ..  neufle.neu[:f - 1dl, :f]
        ..  neufle[:xneu, :xneu + 0.1dl]
    );
    with layer = 1 line_badge(:open, neufle[:sto + 2.0km], "1040");
    with layer = 1 line_badge(:open, neufle[:oro - 3.0km], "1040");

    # Stover
    with layer = -1 marker(:de.bk :removed :left, neufle[:sto] << 0.5dt);

    # Aspe
    with layer = -1 marker(:de.bf :closed :right, neufle[:asp] >> 0.5dt);
    slabel(:right :closed, neufle[:asp - 0.6ssw] >> 0.5dt >> 1.5ssw, "Aspe");

    # Nortorf
    marker(:de.bf :right, neufle[:nor] >> 0.5dt);
    slabel(:right, neufle[:nor - 0.6ssw] >> 0.5dt >> 1.5ssw, "Nortorf");

    # Bokel
    with layer = -1 marker(:de.hp :closed :left, neufle[:bok] << 0.5dt);
    slabel(:left :closed, neufle[:bok - 0.4ssw] << 0.5dt << 1.8ssw, "Bokel");

    # Bokelholm
    with layer = -1 marker(:de.bf :closed :right, neufle[:boh] >> 0.5dt);
    slabel(:right :closed, neufle[:boh - 0.5ssw] >> 0.5dt >> 1.5ssw,
        "Bokelholm"
    );

    # Osterrönfeld
    track(:double :first :cat, neufle[:oro - 1ssw, :oro + 1ssw]);
    track(:first,
            neufle[:oro - 1ssw, :oro - 1ssw + 0.1dl] >> 1.5dt
        --  neufle[:oro - 1ssw + 1dl, :oro - 1ssw + 1.1dl] >> 0.5dt
    );
    marker(:de.bf :right, neufle[:oro] >> 0.5dt);
    slabel(:right, neufle[:oro] + (1.5km, 0km),
        span(:small :bold, "Osterrönfeld")
    );

    # Streckengleis Osterrönfeld - Rendsburg
    with layer = 2 track(:double :first :cat, neufle[:oro + 1ssw, :ren.a]);
    with layer = 1.5 casing(:double :first :cat, neufle[:bhba, :bhbf]);

    # Betriebsstellen auf der Hochbrücke
    with layer = 1.8 {
        marker(:de.uest :right, neufle[:orb] >> 0.5dt);
        marker(:de.bk :removed :left, neufle[:hbr] << 0.5dt);
        marker(:de.uest :removed :left, neufle[:rbr] << 0.5dt);
        marker(:de.bk :removed :left, neufle[:rsl] << 0.5dt);
    }

    # Rendsburg
    track(:double :first :station, neufle[:ren.a, :bud.a]);
    marker(:de.bf :left, neufle[:ren] << 0.5dt);
    slabel(:left, neufle[:ren - .2ssw] << 0.5dt << 2.0ssw,
        span(:small :bold, "Rendsburg")
    );

    # Büdelsdorf
    track(:double :first :station, neufle[:bud.a, :bud + 1ssw]);
    with layer = -1 marker(:de.bf :closed :left, neufle[:bud] << 0.5dt);
    slabel(:right :closed, neufle[:bud - 0.3ssw] >> 1.5dt,
        span(:small :bold :closed, "Büdelsdorf")
    );

    # Büdelsdorf (ausschl) - Schleswig (ausschl)
    track(:double :first :cat, neufle[:bud + 1ssw, :sle - 1sw]);
    with layer = 2 line_badge(:open, neufle[:bud + 2.8km], "1040");

    # Alt Duvenstedt
    with layer = -1 marker(:de.hst :closed, neufle[:adu] >> 0.5dt);
    with layer = -2 marker(:de.bf :gone, neufle[:adu] >> 0.5dt);
    slabel(:right :closed, neufle[:adu - .6ssw] >> 0.5dt >> 1.3ssw,
        "Alt Duvenstedt"
    );

    # Owschlag
    marker(:de.bf, neufle[:ows] >> 0.5dt);
    slabel(:left, neufle[:ows - 0.6ssw] << 2.5dt,
        span(:small :bold, "Owschlag")
    );

    # Lottorf
    with layer = -1 marker(:de.uest :closed :right, neufle[:lot] >> 0.5dt);
    with layer = -2 marker(:de.bf :gone :right, neufle[:lot] >> 0.5dt);
    slabel(:right :closed, neufle[:lot - .6ssw] >> 0.5dt >> 1.3ssw, "Lottorf");

    # Schleswig
    #
    track(:double :first :station, neufle[:sle - 1sw, :asla]);
    marker(:de.bf :right, neufle[:sle] >> .5dt);
    slabel(:right, neufle[:sle - 0.5ssw] >> .5dt >> 1.5ssw,
        span(:small :bold, "Schleswig")
    );

    # Schleswig (ausschl) - Jübeck (ausschl).
    #
    track(:double :first :cat, neufle[:sle, :jub - 1sw]);
    with layer = 2 line_badge(:open, neufle[:sub + 3.5km], "1040");

    with layer = -1 marker(:de.bf :removed :left, neufle[:sub] << 0.5dt);
    marker(:de.awanst :left, neufle[:sub] << 0.5dt);
    slabel(:left, neufle[:sub] << 0.5dt << 2ssw, "Schuby");

    # Jübeck
    #
    track(:double :first :station, neufle[:jub - 1sw, :ahus + .2km]);
    marker(:de.bf :left, neufle[:jub] << 0.5dt);
    slabel(:right :bold, neufle[:jub - 0.5ssw] >> 1.5dt,
        span(:bold :small, "Jübek")
    );

    # Jübeck (aussschl) - Flensburg Weiche (ausschl)
    #
    track(:double :first :cat, neufle[:ahus + .2km, :fws - 1ssw]);
    with layer = 2 line_badge(:open, neufle[:jub + 4.5km], "1040");

    with layer = -2 marker(:de.hst :closed :left, neufle[:egb] << 0.5dt);
    with layer = -1 marker(:de.bf :removed :left, neufle[:egb] << 0.5dt);
    slabel(:right :closed, neufle[:egb - .5ssw] >> 1.5dt, "Eggebek");

    with layer = -1 marker(:de.bf :removed, neufle[:tar] >> .5dt);
    marker(:de.hp, neufle[:tar] >> .5dt);
    slabel(:right, neufle[:tar - .5ssw] >> 0.5dt >> 2ssw, "Tarp");

    marker(:de.hp :removed :left, neufle[:bar] << .5dt);
    marker(:de.bk :removed :left, neufle[:bar] << .5dt);
    slabel(:right :removed, neufle[:bar - 0.5ssw] >> 1.0dt, "Barderup");

    # Flensburg Weiche
    #
    track(:double :first :station, neufle[:fws - 1ssw, :flw + 1ssw]);
    marker(:de.bft :right, neufle[:fws] >> 0.5dt);
    marker(:de.bf :right, neufle[:flw] >> 0.5dt);
    slabel(:bottom, neufle[:flw] >> .5dt >> 2ssw + (20pt, 0pt),
        span(:small :bold, "Flensburg Weiche")
    );

    # Flensburg Weiche (ausschl) - Flensburg (ausschl)
    #
    track(:double :first :cat, neufle[:flw + 1ssw, :fle - 1ssw]);

    # Flensburg
    #
    track(:double :first :station, neufle[:fle - 1ssw, :fle + 1ssw]);
    track(:first :station,
            neufle[:fle + .5ssw, :flw + 1ssw] >> 0.5dt
        --  neufle[:flw + 1ssw + 1dl, :flw + 1ssw + 1.1dl] << 0.5dt
    );
    marker(:de.bf :left, neufle[:fle] << .5dt);
    with layer = 1 slabel(:top, neufle[:fle] << .5dt << 2ssw,
        span(:small :bold, "Flensburg")
    );
}

